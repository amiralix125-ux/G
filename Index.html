<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Win Win Gram Glass Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js"></script>
    <style>
        :root {
            --gold: #d4af37;
            --gold-light: #f3e5ab;
            --gold-dark: #aa8922;
            --text-color: #fef9e6;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body { 
            font-family: Tahoma, sans-serif; 
            margin: 0; 
            height: 100vh; 
            background: radial-gradient(circle at top right, #1a2634, #050a12);
            display: flex; 
            justify-content: center; 
            overflow: hidden; 
            color: var(--text-color); 
        }

        .chat-container { 
            width: 100%; 
            max-width: 500px; 
            height: 100vh; 
            background: rgba(11, 19, 32, 0.7); 
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px);
            display: flex; 
            flex-direction: column; 
            position: relative; 
            border-left: 1px solid rgba(212, 175, 55, 0.2); 
            border-right: 1px solid rgba(212, 175, 55, 0.2); 
        }

        /* بخش ایموجی مرکزی در پس‌زمینه */
        .center-emoji-bg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            z-index: 0;
            opacity: 0.2;
            pointer-events: none;
        }

        .header { 
            background: rgba(11, 19, 32, 0.5); 
            padding: 15px; 
            text-align: center; 
            border-bottom: 1px solid var(--gold); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 10px; 
            z-index: 20; 
        }
        .header b { 
            font-size: 1.3rem; 
            background: linear-gradient(to right, #f3e5ab, var(--gold), #aa8922); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        
        #pinBar { display: none; background: rgba(212, 175, 55, 0.1); backdrop-filter: blur(10px); border-bottom: 1px solid var(--gold); padding: 8px 15px; align-items: center; justify-content: space-between; font-size: 0.8rem; color: var(--gold); z-index: 10; }

        .chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; position: relative; z-index: 1; }
        
        .message { 
            max-width: 85%; 
            padding: 12px; 
            border-radius: 18px; 
            font-size: 0.9rem; 
            position: relative; 
            cursor: pointer; 
            animation: pop 0.2s ease-out;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        @keyframes pop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .user { align-self: flex-end; background: rgba(26, 38, 52, 0.6); border: 1px solid rgba(212, 175, 55, 0.4); border-bottom-left-radius: 4px; }
        .bot { align-self: flex-start; background: rgba(57, 77, 95, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); border-bottom-right-radius: 4px; }

        .replied-info { background: rgba(0, 0, 0, 0.3); border-right: 3px solid var(--gold); padding: 5px 8px; border-radius: 5px; margin-bottom: 8px; font-size: 0.75rem; color: #ccc; display: block; }
        .meta { font-size: 0.6rem; display: flex; align-items: center; gap: 4px; justify-content: flex-end; margin-top: 5px; opacity: 0.7; }

        .context-menu { position: fixed; background: rgba(22, 34, 42, 0.9); backdrop-filter: blur(20px); border: 1px solid var(--gold); border-radius: 15px; width: 190px; display: none; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.5); overflow: hidden; }
        .menu-item { padding: 12px 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid rgba(212, 175, 55, 0.1); font-size: 0.85rem; }
        .menu-item i { color: var(--gold); width: 18px; text-align: center; }
        .delete-submenu { display: none; background: rgba(44, 17, 17, 0.8); border-top: 1px solid #ff4d4d; }

        .input-area-wrap { background: rgba(8, 14, 24, 0.6); backdrop-filter: blur(10px); border-top: 1px solid rgba(212, 175, 55, 0.2); z-index: 10; }
        #replyBar { display: none; background: rgba(26, 38, 52, 0.8); border-right: 3px solid var(--gold); padding: 5px 15px; font-size: 0.8rem; margin: 0 10px; border-radius: 5px 5px 0 0; }
        .input-area { padding: 12px; display: flex; align-items: center; gap: 10px; padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
        .input-area input { flex: 1; background: rgba(26, 38, 52, 0.5); border: 1px solid rgba(212, 175, 55, 0.3); padding: 10px 15px; border-radius: 20px; color: white; }
        .gold-icon { color: var(--gold); font-size: 1.3rem; cursor: pointer; }
    </style>
</head>
<body>

<div class="chat-container">
    <div class="header">
        <b>WIN WIN GRAM</b>
    </div>

    <div id="center-lottie" class="center-emoji-bg"></div>

    <div id="pinBar">
        <span id="pinContent">پیام سنجاق شده...</span>
        <i class="fas fa-times" onclick="unpin()" style="cursor:pointer"></i>
    </div>
    
    <div class="chat-box" id="chatBox"></div>

    <div class="input-area-wrap">
        <div id="replyBar">
            <div style="display:flex; justify-content:space-between; align-items: center;">
                <small id="replyText">پاسخ به...</small>
                <i class="fas fa-times" onclick="closeReply()" style="cursor:pointer; font-size: 0.7rem;"></i>
            </div>
        </div>
        <div class="input-area">
            <div style="display: flex; gap: 12px;">
                <i class="fas fa-image gold-icon" onclick="document.getElementById('fileInp').click()"></i>
                <i class="fas fa-microphone gold-icon" id="micBtn" onclick="toggleRecording()"></i>
            </div>
            <input type="text" id="userInput" placeholder="پیام خود را بنویسید...">
            <i class="fas fa-paper-plane gold-icon" onclick="handleSend()"></i>
            <input type="file" id="fileInp" hidden accept="image/*" onchange="sendImage(this)">
        </div>
    </div>
</div>

<div id="msgMenu" class="context-menu">
    <div class="menu-item" onclick="prepareReply()"><i class="fas fa-reply"></i> پاسخ</div>
    <div class="menu-item" onclick="copyMsg()"><i class="fas fa-copy"></i> کپی</div>
    <div class="menu-item" onclick="pinMsg()"><i class="fas fa-thumbtack"></i> سنجاق</div>
    <div class="menu-item" onclick="startEdit()"><i class="fas fa-edit"></i> ویرایش</div>
    <div class="menu-item" style="color:#ff4d4d" onclick="toggleDelSub(event)">
        <i class="fas fa-trash"></i> حذف <i class="fas fa-chevron-left" style="margin-right:auto; font-size:0.6rem"></i>
    </div>
    <div id="delSub" class="delete-submenu">
        <div class="menu-item" onclick="executeDelete('me')">حذف برای من</div>
        <div class="menu-item" onclick="executeDelete('all')">حذف برای همه</div>
    </div>
</div>

<script>
    let activeMsg = null, editMode = false, mediaRecorder, audioChunks = [], isRecording = false;

    // بارگذاری فایل ایموجی .json شما به صورت خارجی
    lottie.loadAnimation({ 
        container: document.getElementById('center-lottie'), 
        renderer: 'svg', 
        loop: true, 
        autoplay: true, 
        path: 'ایموجی .json' // اینجا فایل جداگانه شما متصل می‌شود
    });

    function handleSend() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if (!text) return;
        if (editMode && activeMsg) {
            activeMsg.querySelector('.msg-text').textContent = text;
            editMode = false;
        } else {
            let replyHtml = "";
            if (document.getElementById('replyBar').style.display === 'block') {
                replyHtml = `<div class="replied-info">پاسخ به: ${document.getElementById('replyText').innerText}</div>`;
            }
            createMessage(text, replyHtml);
        }
        input.value = ''; closeReply();
    }

    function createMessage(content, replyHtml = "") {
        const chatBox = document.getElementById('chatBox');
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message user';
        msgDiv.onclick = (e) => openMenu(e, msgDiv);
        const time = new Date().toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit'});
        msgDiv.innerHTML = `${replyHtml}<span class="msg-text">${content}</span><div class="meta">${time} <i class="fas fa-check-double" style="color:var(--gold)"></i></div>`;
        chatBox.appendChild(msgDiv); chatBox.scrollTop = chatBox.scrollHeight;
    }

    function openMenu(e, el) {
        e.stopPropagation(); activeMsg = el;
        const menu = document.getElementById('msgMenu');
        document.getElementById('delSub').style.display = 'none';
        menu.style.display = 'block';
        let x = e.clientX, y = e.clientY;
        if (x > window.innerWidth - 200) x -= 180;
        if (y > window.innerHeight - 300) y -= 250;
        menu.style.left = x + 'px'; menu.style.top = y + 'px';
    }

    function sendImage(input) {
        if (input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => createMessage(`<img src="${e.target.result}" style="max-width:100%; border-radius:10px;">`);
            reader.readAsDataURL(input.files[0]);
        }
    }

    async function toggleRecording() {
        const btn = document.getElementById('micBtn');
        if (!isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const url = URL.createObjectURL(new Blob(audioChunks, { type: 'audio/mp3' }));
                    createMessage(`<audio controls src="${url}" style="width:100%; height:30px;"></audio>`);
                    audioChunks = [];
                };
                mediaRecorder.start(); isRecording = true; btn.style.color = '#ff4d4d';
            } catch(e) { alert("Error mic"); }
        } else {
            mediaRecorder.stop(); isRecording = false; btn.style.color = 'var(--gold)';
        }
    }

    function startEdit() { document.getElementById('userInput').value = activeMsg.querySelector('.msg-text').innerText; editMode = true; document.getElementById('userInput').focus(); }
    function prepareReply() { 
        document.getElementById('replyText').innerText = activeMsg.querySelector('.msg-text').innerText.substring(0, 30);
        document.getElementById('replyBar').style.display = 'block'; document.getElementById('userInput').focus();
    }
    function pinMsg() { document.getElementById('pinContent').innerText = activeMsg.querySelector('.msg-text').innerText.substring(0, 30); document.getElementById('pinBar').style.display = 'flex'; }
    function unpin() { document.getElementById('pinBar').style.display = 'none'; }
    function closeReply() { document.getElementById('replyBar').style.display = 'none'; }
    function copyMsg() { navigator.clipboard.writeText(activeMsg.querySelector('.msg-text').innerText); }
    function toggleDelSub(e) { e.stopPropagation(); const s = document.getElementById('delSub'); s.style.display = s.style.display === 'block' ? 'none' : 'block'; }
    function executeDelete(t) { activeMsg.remove(); document.getElementById('msgMenu').style.display = 'none'; }

    document.addEventListener('click', () => document.getElementById('msgMenu').style.display = 'none');
</script>

</body>
</html>
